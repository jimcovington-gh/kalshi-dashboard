AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Kalshi Dashboard API - Multi-user trading dashboard with admin support
Globals:
  Function:
    Timeout: 30
    Runtime: python3.12
    MemorySize: 256
    Environment:
      Variables:
        TRADES_TABLE: production-kalshi-trades-v2
        POSITIONS_TABLE: production-kalshi-market-positions
        PORTFOLIO_TABLE: production-kalshi-portfolio-snapshots-v2
        MARKET_METADATA_TABLE: production-kalshi-market-metadata
        CONFIG_BUCKET_NAME: production-kalshi-trading-config
Parameters:
  CognitoUserPoolArn:
    Type: String
    Description: ARN of the Cognito User Pool for authentication
    Default: arn:aws:cognito-idp:us-east-1:355149669325:userpool/us-east-1_WEozUeojc
  TISVpcSubnets:
    Type: CommaDelimitedList
    Default: subnet-0ba02a0291289ed61,subnet-00f42ffa626fb65bc
    Description: Subnets for Lambdas that need TIS access (private subnets with NAT)
  TISVpcSecurityGroups:
    Type: CommaDelimitedList
    Default: sg-07bca88870ac173f8
    Description: Security group allowing TIS access (tis.production.local:8080)
  PortfolioFetcherLayerArn:
    Type: String
    Description: ARN of the PortfolioFetcherLayer (used by ai-chat for cryptography
      deps)
    Default: ''
Resources:
  DashboardApi:
    Type: AWS::Serverless::Api
    Properties:
      Name: kalshi-dashboard-api
      StageName: prod
      Cors:
        AllowMethods: '''GET,POST,OPTIONS'''
        AllowHeaders: '''Content-Type,Authorization,X-Amz-Date,X-Api-Key,X-Amz-Security-Token'''
        AllowOrigin: '''*'''
        MaxAge: '''600'''
      Auth:
        DefaultAuthorizer: CognitoAuthorizer
        Authorizers:
          CognitoAuthorizer:
            UserPoolArn:
              Ref: CognitoUserPoolArn
            Identity:
              Header: Authorization
        AddDefaultAuthorizerToCorsPreflight: false
  GetTradesFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: dashboard-get-trades
      CodeUri: GetTradesFunction
      Handler: get-trades.lambda_handler
      Description: Get trade history for a market ticker
      AutoPublishAlias: live
      ProvisionedConcurrencyConfig:
        ProvisionedConcurrentExecutions: 1
      Layers:
      - Ref: SharedCodeLayer
      Policies:
      - DynamoDBReadPolicy:
          TableName: production-kalshi-trades-v2
      - Statement:
        - Effect: Allow
          Action:
          - dynamodb:Query
          Resource:
          - arn:aws:dynamodb:us-east-1:355149669325:table/production-kalshi-trades-v2/index/*
      Events:
        GetTrades:
          Type: Api
          Properties:
            RestApiId:
              Ref: DashboardApi
            Path: /trades
            Method: GET
    Metadata:
      SamResourceId: GetTradesFunction
  GetPortfolioFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: dashboard-get-portfolio
      CodeUri: GetPortfolioFunction
      Handler: get-portfolio.lambda_handler
      Description: Get portfolio data for user(s) via TIS
      AutoPublishAlias: live
      ProvisionedConcurrencyConfig:
        ProvisionedConcurrentExecutions: 1
      VpcConfig:
        SubnetIds:
          Ref: TISVpcSubnets
        SecurityGroupIds:
          Ref: TISVpcSecurityGroups
      Layers:
      - Ref: SharedCodeLayer
      Environment:
        Variables:
          TIS_ENDPOINT: http://tis.production.local:8080
      Policies:
      - DynamoDBReadPolicy:
          TableName: production-kalshi-market-positions
      - DynamoDBReadPolicy:
          TableName: production-kalshi-portfolio-snapshots-v2
      - DynamoDBReadPolicy:
          TableName: production-kalshi-market-metadata
      - DynamoDBReadPolicy:
          TableName: production-kalshi-trades-v2
      - Statement:
        - Effect: Allow
          Action:
          - dynamodb:Query
          Resource:
          - arn:aws:dynamodb:us-east-1:355149669325:table/production-kalshi-trades-v2/index/*
      - S3ReadPolicy:
          BucketName: production-kalshi-trading-config
      - Statement:
        - Effect: Allow
          Action:
          - ec2:CreateNetworkInterface
          - ec2:DescribeNetworkInterfaces
          - ec2:DeleteNetworkInterface
          Resource: '*'
      Events:
        GetPortfolio:
          Type: Api
          Properties:
            RestApiId:
              Ref: DashboardApi
            Path: /portfolio
            Method: GET
    Metadata:
      SamResourceId: GetPortfolioFunction
  GetAnalyticsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: dashboard-get-analytics
      CodeUri: GetAnalyticsFunction
      Handler: get-analytics.lambda_handler
      Description: Get analytics data (PnL by category)
      AutoPublishAlias: live
      ProvisionedConcurrencyConfig:
        ProvisionedConcurrentExecutions: 1
      Layers:
      - Ref: SharedCodeLayer
      Environment:
        Variables:
          SETTLEMENTS_TABLE: production-kalshi-settlements
          MARKET_METADATA_TABLE: production-kalshi-market-metadata
      Policies:
      - DynamoDBReadPolicy:
          TableName: production-kalshi-settlements
      - DynamoDBReadPolicy:
          TableName: production-kalshi-market-metadata
      - Statement:
        - Effect: Allow
          Action:
          - secretsmanager:GetSecretValue
          Resource:
          - arn:aws:secretsmanager:us-east-1:355149669325:secret:production/kalshi/users/*
      Events:
        GetAnalytics:
          Type: Api
          Properties:
            RestApiId:
              Ref: DashboardApi
            Path: /analytics
            Method: GET
    Metadata:
      SamResourceId: GetAnalyticsFunction
  GetSettlementsAnalyticsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: dashboard-get-settlements-analytics
      CodeUri: GetSettlementsAnalyticsFunction
      Handler: get-settlements-analytics.lambda_handler
      Description: Get settlement analytics from enriched trades-v2 table
      AutoPublishAlias: live
      ProvisionedConcurrencyConfig:
        ProvisionedConcurrentExecutions: 1
      Layers:
      - Ref: SharedCodeLayer
      Environment:
        Variables:
          TRADES_TABLE: production-kalshi-trades-v2
          MARKET_METADATA_TABLE: production-kalshi-market-metadata
          TRADED_MARKET_METADATA_TABLE: production-kalshi-traded-market-metadata
      Policies:
      - DynamoDBReadPolicy:
          TableName: production-kalshi-trades-v2
      - DynamoDBReadPolicy:
          TableName: production-kalshi-market-metadata
      - DynamoDBReadPolicy:
          TableName: production-kalshi-traded-market-metadata
      - Statement:
        - Effect: Allow
          Action:
          - dynamodb:Query
          Resource:
          - arn:aws:dynamodb:us-east-1:355149669325:table/production-kalshi-trades-v2/index/*
      Events:
        GetSettlementsAnalytics:
          Type: Api
          Properties:
            RestApiId:
              Ref: DashboardApi
            Path: /analytics/settlements
            Method: GET
    Metadata:
      SamResourceId: GetSettlementsAnalyticsFunction
  TradingStatusFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: dashboard-trading-status
      CodeUri: TradingStatusFunction
      Handler: trading-status.lambda_handler
      Description: Get and set trading shutdown status (admin only for POST)
      AutoPublishAlias: live
      Layers:
      - Ref: SharedCodeLayer
      Policies:
      - DynamoDBCrudPolicy:
          TableName: production-kalshi-trading-shutdown-signals
      - S3ReadPolicy:
          BucketName: production-kalshi-trading-config
      - Statement:
        - Effect: Allow
          Action:
          - secretsmanager:ListSecrets
          Resource: '*'
      Events:
        GetTradingStatus:
          Type: Api
          Properties:
            RestApiId:
              Ref: DashboardApi
            Path: /trading-status
            Method: GET
        SetTradingStatus:
          Type: Api
          Properties:
            RestApiId:
              Ref: DashboardApi
            Path: /trading-status
            Method: POST
    Metadata:
      SamResourceId: TradingStatusFunction
  AdminStatsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: dashboard-admin-stats
      CodeUri: AdminStatsFunction
      Handler: get-admin-stats.lambda_handler
      Description: Get admin statistics (market capture runs, recent orders/trades)
      AutoPublishAlias: live
      ProvisionedConcurrencyConfig:
        ProvisionedConcurrentExecutions: 1
      Layers:
      - Ref: SharedCodeLayer
      Environment:
        Variables:
          ORDERS_TABLE: production-kalshi-orders
          TRADES_TABLE: production-kalshi-trades-v2
          MENTION_EVENTS_TABLE: production-kalshi-mention-events
      Policies:
      - DynamoDBReadPolicy:
          TableName: production-kalshi-orders
      - DynamoDBReadPolicy:
          TableName: production-kalshi-trades-v2
      - DynamoDBReadPolicy:
          TableName: production-kalshi-mention-events
      - Statement:
        - Effect: Allow
          Action:
          - cloudwatch:GetMetricStatistics
          Resource: '*'
      Events:
        GetAdminStats:
          Type: Api
          Properties:
            RestApiId:
              Ref: DashboardApi
            Path: /admin-stats
            Method: GET
    Metadata:
      SamResourceId: AdminStatsFunction
  VolatileWatchlistFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: dashboard-volatile-watchlist
      CodeUri: VolatileWatchlistFunction
      Handler: get-volatile-watchlist.lambda_handler
      Description: Get volatile watchlist entries (admin only)
      AutoPublishAlias: live
      ProvisionedConcurrencyConfig:
        ProvisionedConcurrentExecutions: 1
      Layers:
      - Ref: SharedCodeLayer
      Environment:
        Variables:
          WATCHLIST_TABLE: production-kalshi-volatile-watchlist
          MARKET_METADATA_TABLE: production-kalshi-market-metadata
      Policies:
      - DynamoDBCrudPolicy:
          TableName: production-kalshi-volatile-watchlist
      - DynamoDBReadPolicy:
          TableName: production-kalshi-market-metadata
      Events:
        GetVolatileWatchlist:
          Type: Api
          Properties:
            RestApiId:
              Ref: DashboardApi
            Path: /volatile-watchlist
            Method: GET
    Metadata:
      SamResourceId: VolatileWatchlistFunction
  VolatileOrdersFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: dashboard-volatile-orders
      CodeUri: VolatileOrdersFunction
      Handler: get-volatile-orders.handler
      Description: Get volatile dip-buy orders from last 24h (admin only)
      AutoPublishAlias: live
      ProvisionedConcurrencyConfig:
        ProvisionedConcurrentExecutions: 1
      Layers:
      - Ref: SharedCodeLayer
      Environment:
        Variables:
          TRADES_TABLE: production-kalshi-trades-v2
      Policies:
      - DynamoDBReadPolicy:
          TableName: production-kalshi-trades-v2
      - Statement:
        - Effect: Allow
          Action:
          - dynamodb:Query
          Resource:
          - arn:aws:dynamodb:us-east-1:355149669325:table/production-kalshi-trades-v2/index/*
      Events:
        GetVolatileOrders:
          Type: Api
          Properties:
            RestApiId:
              Ref: DashboardApi
            Path: /volatile-orders
            Method: GET
    Metadata:
      SamResourceId: VolatileOrdersFunction
  MentionMonitorsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: dashboard-mention-monitors
      CodeUri: MentionMonitorsFunction
      Handler: mention-monitors.lambda_handler
      Description: Get and clear mention monitor status (admin only)
      Timeout: 60
      AutoPublishAlias: live
      ProvisionedConcurrencyConfig:
        ProvisionedConcurrentExecutions: 1
      Environment:
        Variables:
          MENTION_STATE_TABLE: production-kalshi-mention-event-state
          ECS_CLUSTER: production-kalshi-fargate-cluster
      Policies:
      - DynamoDBCrudPolicy:
          TableName: production-kalshi-mention-event-state
      - Statement:
        - Effect: Allow
          Action:
          - ecs:ListTasks
          - ecs:StopTask
          - ecs:DescribeTasks
          Resource: '*'
          Condition:
            ArnLike:
              ecs:cluster:
                Fn::Sub: arn:aws:ecs:${AWS::Region}:${AWS::AccountId}:cluster/production-kalshi-fargate-cluster
      Events:
        GetMentionMonitors:
          Type: Api
          Properties:
            RestApiId:
              Ref: DashboardApi
            Path: /mention-monitors
            Method: GET
        ClearMentionMonitors:
          Type: Api
          Properties:
            RestApiId:
              Ref: DashboardApi
            Path: /mention-monitors/clear
            Method: POST
    Metadata:
      SamResourceId: MentionMonitorsFunction
  VoiceTraderRouterFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: dashboard-voice-trader-router
      CodeUri: VoiceTraderRouterFunction
      Handler: voice-trader-router.lambda_handler
      Description: Launch and manage voice trading containers for mention markets
      Timeout: 60
      AutoPublishAlias: live
      ProvisionedConcurrencyConfig:
        ProvisionedConcurrentExecutions: 1
      Environment:
        Variables:
          ECS_CLUSTER: production-kalshi-fargate-cluster
          TASK_FAMILY: production-voice-mention-trader
          VOICE_TRADER_STATE_TABLE: production-kalshi-voice-trader-state
          VOICE_TRADER_QUEUE_TABLE: production-kalshi-voice-trader-queue
          MENTION_EVENTS_TABLE: production-kalshi-mention-events
          MARKET_METADATA_TABLE: production-kalshi-market-metadata
          SUBNETS: subnet-0ba02a0291289ed61
          SECURITY_GROUPS: sg-056792d76ef21c4c5
          VOICE_TRADER_EC2_INSTANCE_ID: i-007fa64f2c29180ec
      Policies:
      - DynamoDBCrudPolicy:
          TableName: production-kalshi-voice-trader-state
      - DynamoDBCrudPolicy:
          TableName: production-kalshi-voice-trader-queue
      - DynamoDBReadPolicy:
          TableName: production-kalshi-mention-events
      - DynamoDBReadPolicy:
          TableName: production-kalshi-market-metadata
      - Statement:
        - Effect: Allow
          Action:
          - ecs:RunTask
          - ecs:StopTask
          - ecs:DescribeTasks
          - ecs:ListTasks
          Resource: '*'
          Condition:
            ArnLike:
              ecs:cluster:
                Fn::Sub: arn:aws:ecs:${AWS::Region}:${AWS::AccountId}:cluster/production-kalshi-fargate-cluster
      - Statement:
        - Effect: Allow
          Action:
          - iam:PassRole
          Resource:
          - Fn::Sub: arn:aws:iam::${AWS::AccountId}:role/production-voice-mention-trader-task-execution-role
          - Fn::Sub: arn:aws:iam::${AWS::AccountId}:role/production-voice-mention-trader-task-role
      - Statement:
        - Effect: Allow
          Action:
          - secretsmanager:GetSecretValue
          Resource:
          - arn:aws:secretsmanager:us-east-1:355149669325:secret:production/kalshi/users/*
      - Statement:
        - Effect: Allow
          Action:
          - ec2:DescribeNetworkInterfaces
          Resource: '*'
      - Statement:
        - Effect: Allow
          Action:
          - ec2:DescribeInstances
          - ec2:StartInstances
          - ec2:StopInstances
          - ec2:RebootInstances
          Resource:
            Fn::Sub: arn:aws:ec2:${AWS::Region}:${AWS::AccountId}:instance/i-007fa64f2c29180ec
      - Statement:
        - Effect: Allow
          Action:
          - ec2:DescribeInstances
          Resource: '*'
      - Statement:
        - Effect: Allow
          Action:
          - ssm:SendCommand
          - ssm:GetCommandInvocation
          Resource:
          - Fn::Sub: arn:aws:ssm:${AWS::Region}::document/AWS-RunShellScript
          - Fn::Sub: arn:aws:ec2:${AWS::Region}:${AWS::AccountId}:instance/i-007fa64f2c29180ec
      Events:
        GetEvents:
          Type: Api
          Properties:
            RestApiId:
              Ref: DashboardApi
            Path: /voice-trader/events
            Method: GET
        LaunchSession:
          Type: Api
          Properties:
            RestApiId:
              Ref: DashboardApi
            Path: /voice-trader/launch
            Method: POST
        GetStatus:
          Type: Api
          Properties:
            RestApiId:
              Ref: DashboardApi
            Path: /voice-trader/status/{session_id}
            Method: GET
        StopSession:
          Type: Api
          Properties:
            RestApiId:
              Ref: DashboardApi
            Path: /voice-trader/stop/{session_id}
            Method: POST
        DialSession:
          Type: Api
          Properties:
            RestApiId:
              Ref: DashboardApi
            Path: /voice-trader/dial/{session_id}
            Method: POST
        RedialSession:
          Type: Api
          Properties:
            RestApiId:
              Ref: DashboardApi
            Path: /voice-trader/redial/{session_id}
            Method: POST
        EC2Status:
          Type: Api
          Properties:
            RestApiId:
              Ref: DashboardApi
            Path: /voice-trader/ec2/status
            Method: GET
        EC2Start:
          Type: Api
          Properties:
            RestApiId:
              Ref: DashboardApi
            Path: /voice-trader/ec2/start
            Method: POST
        EC2Stop:
          Type: Api
          Properties:
            RestApiId:
              Ref: DashboardApi
            Path: /voice-trader/ec2/stop
            Method: POST
        EC2Reboot:
          Type: Api
          Properties:
            RestApiId:
              Ref: DashboardApi
            Path: /voice-trader/ec2/reboot
            Method: POST
        EC2Launch:
          Type: Api
          Properties:
            RestApiId:
              Ref: DashboardApi
            Path: /voice-trader/ec2/launch
            Method: POST
        QueueAdd:
          Type: Api
          Properties:
            RestApiId:
              Ref: DashboardApi
            Path: /voice-trader/ec2/queue/add
            Method: POST
        QueueRemove:
          Type: Api
          Properties:
            RestApiId:
              Ref: DashboardApi
            Path: /voice-trader/ec2/queue/remove
            Method: POST
        QueueList:
          Type: Api
          Properties:
            RestApiId:
              Ref: DashboardApi
            Path: /voice-trader/ec2/queue/list
            Method: GET
        QueueCleanStale:
          Type: Api
          Properties:
            RestApiId:
              Ref: DashboardApi
            Path: /voice-trader/ec2/queue/clean-stale
            Method: POST
        GetWorkers:
          Type: Api
          Properties:
            RestApiId:
              Ref: DashboardApi
            Path: /voice-trader/ec2/workers
            Method: GET
    Metadata:
      SamResourceId: VoiceTraderRouterFunction
  AIChatFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: dashboard-ai-chat
      CodeUri: AIChatFunction
      Handler: ai-chat.lambda_handler
      Description: AI chat assistant with read-only access to trading data
      Timeout: 900
      MemorySize: 512
      AutoPublishAlias: live
      Layers:
      - Ref: SharedCodeLayer
      - Ref: PortfolioFetcherLayerArn
      Environment:
        Variables:
          LOG_LEVEL: INFO
          CONVERSATIONS_BUCKET: production-kalshi-trading-config
      Policies:
      - Statement:
        - Effect: Allow
          Action:
          - bedrock:InvokeModel
          - bedrock:Converse
          Resource:
          - arn:aws:bedrock:*::foundation-model/anthropic.claude-opus-4-6-v1
          - Fn::Sub: arn:aws:bedrock:${AWS::Region}:${AWS::AccountId}:inference-profile/us.anthropic.claude-opus-4-6-v1
      - DynamoDBReadPolicy:
          TableName: production-kalshi-event-archive
      - DynamoDBReadPolicy:
          TableName: production-kalshi-event-metadata
      - DynamoDBReadPolicy:
          TableName: production-kalshi-market-metadata
      - DynamoDBReadPolicy:
          TableName: production-kalshi-mention-event-rotation
      - DynamoDBReadPolicy:
          TableName: production-kalshi-mention-event-state
      - DynamoDBReadPolicy:
          TableName: production-kalshi-mention-event-termination
      - DynamoDBReadPolicy:
          TableName: production-kalshi-mention-events
      - DynamoDBReadPolicy:
          TableName: production-kalshi-orderbook-snapshots
      - DynamoDBReadPolicy:
          TableName: production-kalshi-orders
      - DynamoDBReadPolicy:
          TableName: production-kalshi-portfolio-snapshots
      - DynamoDBReadPolicy:
          TableName: production-kalshi-positions-live
      - DynamoDBReadPolicy:
          TableName: production-kalshi-prohibited-events
      - DynamoDBReadPolicy:
          TableName: production-kalshi-quickbets-sessions
      - DynamoDBReadPolicy:
          TableName: production-kalshi-rate-limiter
      - DynamoDBReadPolicy:
          TableName: production-kalshi-rotation-state
      - DynamoDBReadPolicy:
          TableName: production-kalshi-series-metadata
      - DynamoDBReadPolicy:
          TableName: production-kalshi-traded-market-metadata
      - DynamoDBReadPolicy:
          TableName: production-kalshi-trades-v2
      - DynamoDBReadPolicy:
          TableName: production-kalshi-trading-shutdown-signals
      - DynamoDBReadPolicy:
          TableName: production-kalshi-voice-trader-queue
      - DynamoDBReadPolicy:
          TableName: production-kalshi-voice-trader-sessions
      - DynamoDBReadPolicy:
          TableName: production-kalshi-voice-trader-state
      - DynamoDBReadPolicy:
          TableName: production-kalshi-volatile-watchlist
      - Statement:
        - Effect: Allow
          Action:
          - dynamodb:Query
          Resource:
          - arn:aws:dynamodb:us-east-1:355149669325:table/production-kalshi-*/index/*
      - S3ReadPolicy:
          BucketName: production-kalshi-trading-config
      - S3ReadPolicy:
          BucketName: production-kalshi-trading-captures
      - Statement:
        - Effect: Allow
          Action:
          - s3:PutObject
          - s3:DeleteObject
          Resource:
          - arn:aws:s3:::production-kalshi-trading-config/ai-conversations/*
      - Statement:
        - Effect: Allow
          Action:
          - secretsmanager:GetSecretValue
          Resource:
          - arn:aws:secretsmanager:us-east-1:355149669325:secret:production/kalshi/users/*
      - Statement:
        - Effect: Allow
          Action:
          - secretsmanager:ListSecrets
          Resource: '*'
      - Statement:
        - Effect: Allow
          Action:
          - logs:FilterLogEvents
          - logs:DescribeLogGroups
          Resource:
          - arn:aws:logs:us-east-1:355149669325:log-group:/ecs/kalshi-tis:*
          - arn:aws:logs:us-east-1:355149669325:log-group:/ecs/kalshi-quickbets:*
          - arn:aws:logs:us-east-1:355149669325:log-group:/ecs/production-mention-market-monitor:*
          - arn:aws:logs:us-east-1:355149669325:log-group:/ecs/production-voice-mention-trader:*
      Events:
        AIChat:
          Type: Api
          Properties:
            RestApiId:
              Ref: DashboardApi
            Path: /ai-chat
            Method: POST
        AIChatConversationsGet:
          Type: Api
          Properties:
            RestApiId:
              Ref: DashboardApi
            Path: /ai-chat/conversations
            Method: GET
        AIChatConversationsPost:
          Type: Api
          Properties:
            RestApiId:
              Ref: DashboardApi
            Path: /ai-chat/conversations
            Method: POST
    Metadata:
      SamResourceId: AIChatFunction
  VoiceTraderSchedulerFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: dashboard-voice-trader-scheduler
      CodeUri: VoiceTraderSchedulerFunction
      Handler: voice-trader-scheduler.lambda_handler
      Description: Auto-start Voice Trader EC2 before scheduled events
      Timeout: 30
      Environment:
        Variables:
          VOICE_TRADER_QUEUE_TABLE: production-kalshi-voice-trader-queue
          VOICE_TRADER_EC2_INSTANCE_ID: i-007fa64f2c29180ec
          START_BEFORE_MINUTES: '15'
      Policies:
      - DynamoDBCrudPolicy:
          TableName: production-kalshi-voice-trader-queue
      - Statement:
        - Effect: Allow
          Action:
          - ec2:DescribeInstances
          - ec2:StartInstances
          Resource: '*'
      Events:
        ScheduleRule:
          Type: Schedule
          Properties:
            Schedule: rate(5 minutes)
            Description: Check for upcoming voice trader events and start EC2
            Enabled: true
    Metadata:
      SamResourceId: VoiceTraderSchedulerFunction
  SharedCodeLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: dashboard-shared-code
      Description: Shared utilities (s3_config_loader)
      ContentUri: SharedCodeLayer
      CompatibleRuntimes:
      - python3.12
    Metadata:
      BuildMethod: python3.12
      SamResourceId: SharedCodeLayer
Outputs:
  ApiEndpoint:
    Description: API Gateway endpoint URL
    Value:
      Fn::Sub: https://${DashboardApi}.execute-api.${AWS::Region}.amazonaws.com/prod
  GetTradesFunctionArn:
    Description: Get Trades Lambda ARN
    Value:
      Fn::GetAtt:
      - GetTradesFunction
      - Arn
  GetPortfolioFunctionArn:
    Description: Get Portfolio Lambda ARN
    Value:
      Fn::GetAtt:
      - GetPortfolioFunction
      - Arn
  GetAnalyticsFunctionArn:
    Description: Get Analytics Lambda ARN
    Value:
      Fn::GetAtt:
      - GetAnalyticsFunction
      - Arn
